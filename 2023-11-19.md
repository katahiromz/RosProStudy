# 2023-11-19

今回はいよいよ解析に入る。

## 解析の概要

解析対象のファイルのことを検体と呼びます。

解析には動的解析とスタティックな解析の二種類あって、
動的解析は、検体を実際に動かしてデバッガやWinHier、API Monitorなどを使って調べます。

動的解析で使われるAPI Monitorは、API関数の呼び出し履歴を調べるのに使うツールです。
調べたいAPI関数を選び、調べたいプロセスをアタッチして実行すると呼び出し履歴が得られます。
ただし、呼び出したAPI関数の内部はわかりません。

- API Monitor: http://www.rohitab.com/

スタティックな解析は、検体のバイナリーを実際に動かすことなく

- バイナリエディタ
- リソースエディタ
- 逆アセン＊ラ
- 逆コンパ＊ラなど

を使って調べることを言います。無料で強力な逆コンパ＊ラには、IDA FreeとGhidraがあります。
今回はIDA Freeを使います。

- IDA Free: https://hex-rays.com/ida-free/
- Ghidra: https://ghidra-sre.org/

GhidraはIDA Freeによる解析につまづいたときに使って下さい。

## 解析を始める

解析するためには、検体が必要です。今回はWin2k3のimm32.dllを使います。

Win2k3のC:\Windows\system32フォルダのimm32.dllをコピーして共有フォルダから抽出します。
型情報や関数名などの追加の情報を得るためには、シンボルファイル（*.pdb）が必要です。
WinDbgなどで検体をデバッグすると、可能ならば%PROGRAMDATA%\Dbgにシンボルファイルがダウンロードされます。

imm32.dllを読み込ませてシンボルファイルとしてimm32.pdbを読み込ませることができれば勝利は目前にあります。
しかし、初心者には解析の準備には時間がかかるので、今回はこちらでIDA Freeのファイルを提供します。

内密にしますので、メールアドレスを教えて下さい。今からそちらにIDA Freeのファイル送ります。

## revプログラム

IDA Freeのファイルをそのまま送るのはまずいので、簡単に変換します。

こちらのrevプログラムは指定したファイルの中身をバイト単位で逆順にします。ビルドしてみて下さい。

- rev: https://github.com/katahiromz/rev

```bash
g++ -o rev.exe rev.cpp
```

逆順の逆順は元通りになることはわかりますね。

検体や解析結果を他の人に見せたり、配布したりしないで下さい。

## IDA Freeの使い方の概要

1. IDA Freeのインストールが完了したら、IDA Freeを起動して、検体をドロップして下さい。
2. シンボルファイル（*.pdb）を要求されたら、それらしいPDBファイルを指定して下さい。
   間違っていれば別のPDBファイルを試してみて下さい。
3. 解析がいったん終わったら、左側に関数名の一覧が表示されます。
4. 関数名のリストをクリックしてCtrl+Fを押すと、検索ボックスが表示され、関数の検索が可能です。
5. [View] --> [Open subviews] --> [Generate pseudocode] を選ぶと、逆コン＊イルされたコードが表示されます。
6. [View] --> [Open subviews] --> [Import]を選ぶとインポート関数の一覧が表示されます。
7. [View] --> [Open subviews] --> [Export]を選ぶとDLLファイルのエクスポート関数の一覧が表示されます。
8. [View] --> [Open subviews] --> [Local types]を選ぶと型情報を追加・編集できます。
9. [PseudoCode-A]で変数名・関数名を右クリックして[Set ??? type...]を選ぶと、型を指定できます。
10. [PseudoCode-A]で変数名・関数名を右クリックして[Rename ???]を選ぶと、名前を変更できます。
11. [PseudoCode-A]で変数名・関数名を右クリックして[Jump to xref]を選ぶと、その名前を参照している項目にジャンプできます。
12. [PseudoCode-A]でコードを右クリックして[Edit ??? comment...]を選ぶと、コメントが付けられます。
13. 画面左側の関数名をダブルクリックすると関数を選択できます。

インポート（Import）関数というのは、外部のDLLから関数を「輸入」しているということだから、
インポート関数のリストを調べれば、ある程度、そのモジュールが使用しているAPI関数がわかりますね。

逆にエクスポート（Export）関数というのは、外部に関数を「輸出」しているということだから、
その関数は外部から参照可能であることを意味します。

IDA Freeでは、重複しない限り、変数名を自由に変更できます。ソフトウェア開発において名前付けは大事な作業です。
Win32開発においては、ハンガリアン記法、特にシステムハンガリアンが良く使われます。

- ハンガリアン記法: https://ja.wikipedia.org/wiki/%E3%83%8F%E3%83%B3%E3%82%AC%E3%83%AA%E3%82%A2%E3%83%B3%E8%A8%98%E6%B3%95

【課題4】imm32.dllについて、文字列「CtfIme」を関数名として含む関数を抽出し、解析を進めて見て下さい。

---

[上へ](README.md) | [戻る](2023-11-12.md)
